#!/bin/bash
release=$1
if [ "$release" = "" ]; then
  INDEX=`mktemp index_XXXX.html`
  echo Tempfile for index.html is $INDEX
  wget -O $INDEX http://releases.sapsailing.com/
  release=$(cat $INDEX | grep build- | tail -1 | sed -e 's/^.*\(build-[0-9]*\).*$/\1/')
  rm $INDEX
  echo Latest release is $release
fi
GITROOT="`dirname $0`/.."
DOCKERDIR="${GITROOT}/docker"
DOCKERFILE="$DOCKERDIR/Dockerfile"
echo "Copying files from GITROOT $GITROOT into Docker workspace"
cp "$GITROOT/java/target/env.sh" .
cp "$GITROOT/java/target/start" .
cp "$GITROOT/java/target/configuration/JavaSE-11.profile" .
cat ${DOCKERFILE}.tpl | sed -e "s/RELEASE/${release}/g" >${DOCKERFILE}
cd "$DOCKERDIR"
docker build -t sapsailing:$release .
echo "Cleaning up..."
rm start env.sh JavaSE-11.profile Dockerfile
